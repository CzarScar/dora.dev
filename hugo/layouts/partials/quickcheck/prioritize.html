{{ $Ranks := slice "Strongly disagree" "Disagree" "Neither agree nor disagree" "Agree" "Strongly agree" }}

<div class="prioritize_container" x-data="{
    currentStep:0,
    currentStepComplete: false,
    checkComplete() {
        this.currentStepComplete = this.getStepValues(this.currentStep).every( e => typeof e === 'number')},
    getStepValues() {

        // TODO: replace all this with Alpine data and use x-model to bind to the radio buttons
        let numQuestions=document.querySelectorAll(`#prioritize_${this.currentStep} tbody tr`).length;
    
        let stepValues = new Array();
        for (let i=1; i < numQuestions+1; i++) {
            let thisQuestion = `question_${this.currentStep}_${i}`;
            let selectedValue = '-';
    
            if (document.querySelector(`input[name='${thisQuestion}']:checked`)) {
                selectedValue = parseInt(document.querySelector(`input[name='${thisQuestion}']:checked`).value);
            } else {
                selectedValue = '-';
            }
            stepValues.push(selectedValue);
        }
        return stepValues;
        },
    pushStepValues() {
        // push step values to the URL
        const url = new URL(window.location.href);
        url.searchParams.set(`step_${this.currentStep}`, this.getStepValues().join(''));
        history.pushState(null, document.title, url.toString());
        },
    updateResults() {
        
        Array.prototype.average = function() {
            let sum = this.reduce(function(a, b) {return parseInt(a) + parseInt(b)});
            return sum / this.length;
        };  

        function fiveScaleToDecile(input) {
            return Math.round(((input-1) * 25) / 10) * 10;
        }        

        const url = new URL(window.location.href);
        let ci_average = url.searchParams.get('step_1').split('').average();
        let arch_average = url.searchParams.get('step_2').split('').average();
        let culture_average = url.searchParams.get('step_3').split('').average();

        document.querySelector('#ci_score .capabilityScoreText').innerText = ci_average.toFixed(1);
        document.querySelector('#ci_score .capabilityScoreData').classList.add('percentile_' + fiveScaleToDecile(ci_average));
        document.querySelector('#ci_score .capabilityScoreData').style.width = ci_average * 2 + 'em';

        document.querySelector('#arch_score .capabilityScoreText').innerText = arch_average.toFixed(1);
        document.querySelector('#arch_score .capabilityScoreData').classList.add('percentile_' + fiveScaleToDecile(arch_average));
        document.querySelector('#arch_score .capabilityScoreData').style.width = arch_average * 2 + 'em';

        document.querySelector('#culture_score .capabilityScoreText').innerText = culture_average.toFixed(1);
        document.querySelector('#culture_score .capabilityScoreData').classList.add('percentile_' + fiveScaleToDecile(culture_average));
        document.querySelector('#culture_score .capabilityScoreData').style.width = culture_average * 2 + 'em';
    }
}"
    x-init="
        function() {

            $watch('currentStep', value => {
                if(value == 4) {
                    updateResults();
                }
            });
            
            // if the step values are provided in the URL (e.g. if this link has been copied and emailed), skip to the results
            const url = new URL(window.location.href);
            if (url.searchParams.get('step_1') && url.searchParams.get('step_2') && url.searchParams.get('step_3')) {
                currentStep=4;
                updateResults();
            }
        }"
    >
    <span style="background-color:red;" x-text="'currentStep = ' + currentStep + ' '"></span>
    <div class="prioritize_contents">
        <div class="prioritize_step" id="prioritize_0" x-show="currentStep == 0" x-transition>
            <h2>What's holding you back?</h2>
            <p>
                In our <a href='{{ "/research/" | relURL }}'>research</a>, DORA has identified several key capabilities which drive higher software delivery and organizational performance. Improving these technical, process, and cultural capabilities can help your team deliver more value to your customers and organization. It's important to focus your efforts on the specific thing that  is currently holding you back. While every team will take a different journey, we have identified three capabilities that are often beneficial to improve: <strong>Continuous Integration</strong>, <strong>Loosely Coupled Architecture</strong>, and <strong>Generative Organizational Culture</strong>. 
            </p>
            <div class="prioritization_control">
                <button id="prioritize_button" @click="currentStep++">Help Me Prioritize</button>
                <div class="button_description">
                    <small>
                        Complete a brief survey for each of these three capabilities to determine how you perform and which to consider focusing on first.
                    </small>
                </div>
            </div>
        </div>
        {{ range .Site.Data.capability_prioritization_questions }}
            <div class="prioritize_step" id="prioritize_{{ .step}}" x-show="currentStep == {{ .step }}" @click="checkComplete" x-transition>
                <h2>Capability {{ .step }} of 3: {{ .capability }}</h2>
                <p>{{ .description }} <a href="{{ .article_url }}" target="_blank">Learn more</a></p>
                <table class="prioritize_questions">
                    <thead>
                        <tr>
                            <th>For the primary application or service you work on:</th>
                            {{ range $Ranks }}
                                <th>{{ . }}</th>
                            {{ end }}
                        </tr>
                    </thead>
                    <tbody>
                        {{ $.Scratch.Set "step" .step }}
                        {{ range .questions }}
                            {{ $row_id := (printf "question_%v_%v" ($.Scratch.Get "step") .number) }}
                            <tr>
                                <td>{{ .question_text }}</td>
                                {{ range seq 5 }}
                                    <td><label for='{{$row_id}}_{{.}}'><input type="radio" name='{{$row_id}}' id='{{$row_id}}_{{.}}' value="{{.}}"> <span>{{ index $Ranks (add . -1) }}</span></label></td>
                                {{ end }}
                            </tr>
                        {{ end }}
                    </tbody>
                </table>
                <button 
                    id="prioritize_button" 
                    @click="pushStepValues();currentStep++"
                    :disabled="!currentStepComplete"
                >Next</button>
            </div>
        {{ end }}
        <div class="prioritize_step" id="prioritize_4" x-show="currentStep == 4">
            <h2>Capabilities analysis</h2>
            <p>Based on your responses, here's how your team is performing:</p>
            <table class="capability_scores">
                {{ range .Site.Data.capability_prioritization_questions }}
                <tr>
                    <td>
                        <h2>{{ .capability }}</h2>
                        <a href="{{.article_url}}">Learn more about {{ .capability }}</a>
                    </td>
                    <td id="{{.shortname}}_score">
                        <div class="capabilityScoreContainer">
                            <div class="capabilityScoreGraph">
                                <div class="capabilityScoreData"> </div>
                            </div>
                            <div class="capabilityScore"><span class="capabilityScoreText"></span> / 5</div>
                        </div>
                    </td>
                </tr>
                {{ end }}
            </table>
            <div>
                <p>These are only three of the capabilities that our research has shown to predict software delivery and operations performance. Here are some resources to help you plan the next step of your DevOps journey:</p>
                
                <ul class="prioritization_next_steps">
                    <li>
                        <h3><a href="/devops-capabilities/" target="_blank">Explore DORA's Capabilities Catalog</a></h3>
                        <p>Learn about all of the technical, process, and cultural capabilities that our research has shown to be predictive of software delivery and operations performance.</p>
                    </li>
                    <li>
                        <h3><a href="/contact/">Request a DORA Assessment for your organization</a></h3>
                        <p>This in-depth assessment across multiple capabilities and metrics, provided by Google Cloud, can help you craft a plan for iterative improvement.</p>
                    </li>
                    <li>
                        <h3><a href="https://bit.ly/dora-sodr" target="_blank">Read the latest State of DevOps Report</a></h3>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
